<html>
  <style>
    html, body {
        overflow: hidden;
        width   : 100%;
        height  : 100%;
        margin  : 0;
        padding : 0;
    }

    #renderCanvas {
        width   : 100%;
        height  : 100%;
        touch-action: none;
    }
</style>
<head>
  <meta charset="utf-8">
    <title></title>
    <link href="css/style.css" rel="stylesheet" />
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://cdn.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
    <script src="https://cdn.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
    <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
    <script src="https://cdn.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
    <script src="https://cdn.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>

    <script src="js/artoolkit/artoolkit.min.js"></script>
    <script src="js/artoolkit/artoolkit.debug.js"></script>
  </head>

    <body>
        <p>Icons made by <a href="https://www.flaticon.com/authors/creaticca-creative-agency" title="Creaticca Creative Agency">Creaticca Creative Agency</a> from <a href="https://www.flaticon.com/" title="Flaticon"> www.flaticon.com</a></p>
        <canvas id="renderCanvas" touch-action="none"></canvas> //touch-action="none" for best results from PEP

        <script>
            var video = ARController.getUserMedia({
              maxARVideoSize: 320, // do AR processing on scaled down video of this size
              facing: "environment",
              onSuccess: function(video) {
                console.log('got video', video);
              }
            });

            var canvas = document.getElementById("renderCanvas"); // Get the canvas element 
            var engine = new BABYLON.Engine(canvas, true); // Generate the BABYLON 3D engine

            var sourcePlane = new BABYLON.Plane(0, -1, 1, 0);
                sourcePlane.normalize();
    
            /******* Add the create video scene function *****/
            var createVideoScene = function () {
    
                // Create the scene space
                var scene = new BABYLON.Scene(engine);
    
                // Add a camera to the scene and attach it to the canvas
                var camera = new BABYLON.ArcRotateCamera("Camera", Math.PI / 2, Math.PI / 2, 2, new BABYLON.Vector3(0,0,5), scene);
                camera.attachControl(canvas, true);
    


                var videoMat = new BABYLON.StandardMaterial("videoMat", scene);

                
                // Add and manipulate meshes in the scene
                //var sphere = BABYLON.MeshBuilder.CreateSphere("sphere", {diameter:2}, scene);
                var vscreen = BABYLON.MeshBuilder.CreatePlane("vscrn", {width: 2, height: 2, sideOrientation: BABYLON.Mesh.DOUBLESIDE, sourcePlane: sourcePlane }, scene);
                //card.position = new BABYLON.Vector3(0, 0, -10);
                vscreen.material = videoMat;

                scene.onPointerDown = function () { 
                    videoMat.video.play();
                }

                return scene;
            }

            /******* Add the create scene function ******/
            var createARScene = function () {
    
                // Create the scene space
                var scene = new BABYLON.Scene(engine);
    
                // Add a camera to the scene and attach it to the canvas
                var camera = new BABYLON.ArcRotateCamera("Camera", Math.PI / 2, Math.PI / 2, 2, new BABYLON.Vector3(0,0,5), scene);
                camera.attachControl(canvas, true);
    
                // Add lights to the scene
                var light1 = new BABYLON.HemisphericLight("light1", new BABYLON.Vector3(1, 1, 0), scene);
                var light2 = new BABYLON.PointLight("light2", new BABYLON.Vector3(0, 1, -1), scene);
    
                var sourcePlane = new BABYLON.Plane(0, -1, 1, 0);
                sourcePlane.normalize();

                var cardMat = new BABYLON.StandardMaterial("cardMat", scene);
                
                cardMat.diffuseColor = new BABYLON.Color3(1, 1, 1);
                cardMat.specularColor = new BABYLON.Color3(0.5, 0.6, 0.87);
                cardMat.emissiveColor = new BABYLON.Color3(1, 1, 1);
                cardMat.ambientColor = new BABYLON.Color3(0.23, 0.98, 0.53);
                
                cardMat.diffuseTexture = new BABYLON.Texture("assets/textures/card.png", scene);                                
                //cardMat.emissiveTexture = new BABYLON.Texture("assets/textures/card.png", scene);
                

                // Add and manipulate meshes in the scene
                //var sphere = BABYLON.MeshBuilder.CreateSphere("sphere", {diameter:2}, scene);
                var card = BABYLON.MeshBuilder.CreatePlane("card", {width: 5, height: 2, sideOrientation: BABYLON.Mesh.DOUBLESIDE, sourcePlane: sourcePlane }, scene);
                //card.position = new BABYLON.Vector3(0, 0, -10);
                card.rotation.x = -Math.PI/12;
                card.material = cardMat;
                //card.rotation.y = -Math.PI/3;
                //card.rotation.z = -Math.PI/3;

                var photoMat = new BABYLON.StandardMaterial("photoMat", scene);
                photoMat.diffuseTexture = new BABYLON.Texture("assets/textures/photo.png", scene);
                photoMat.diffuseTexture.hasAlpha = true;
                photoMat.diffuseColor = new BABYLON.Color3(1, 1, 1);
                photoMat.specularColor = new BABYLON.Color3(0.5, 0.6, 0.87);
                photoMat.emissiveColor = new BABYLON.Color3(1, 1, 1);
                photoMat.ambientColor = new BABYLON.Color3(0.23, 0.98, 0.53);
                

                var photo = BABYLON.MeshBuilder.CreatePlane("photo", {width: 1, height: 1, sideOrientation: BABYLON.Mesh.DOUBLESIDE, sourcePlane: sourcePlane}, scene);
                photo.material = photoMat;
                photo.position = new BABYLON.Vector3(-3, 0.5, -0.01);
                photo.rotation.x = -Math.PI/12;
                

                
                return scene;
            };
            /******* End of the create scene function ******/    
    
            var vidscene = createVideoScene();
            var arscene = createARScene(); //Call the createScene function
            var arController = null;

            // run the render loop
            engine.runRenderLoop(function () {
                if (!arController) {
                    return;
                }

                arController.detectMarker(v);
                var markerNum = arController.getMarkerNum();

                if (markerNum > 0) {

                    if (markerRoot.isVisible) {
                        arController.getTransMatSquareCont(0, 1, markerRoot.markerMatrix, markerRoot.markerMatrix);
                    } else {
                        arController.getTransMatSquare(0 /* Marker index */, 1 /* Marker width */, markerRoot.markerMatrix);
                    }

                    markerRoot.isVisible = true;
                    markerRoot.getChildMeshes().forEach(function (mesh) {
                        mesh.isVisible = true
                    });

                    arController.arglCameraViewRHf(arController.transMatToGLMat(markerRoot.markerMatrix), markerRoot._worldMatrix.m);
                } else {
                    markerRoot.isVisible = false;
                    markerRoot.getChildMeshes().forEach(function (mesh) {
                        mesh.isVisible = false;
                    });
                }

                arController.debugDraw();
                
                vidscene.render();
                arscene.render();
            });


            var cameraParam = new ARCameraParam();
            cameraParam.onload = async function () {

                arController = new ARController(v.width, w.height, cameraParam);
                arController.debugSetup();

                camera.freezeProjectionMatrix(BABYLON.Matrix.FromArray(arController.getCameraMatrix()));
            };
            cameraParam.load('assets/camera_para.dat');

            // the canvas/window resize event handler
            window.addEventListener('resize', function () {
                engine.resize();
            });
                    
           
        </script>

        <!--
        <script>
            /*
            var v = ARController.getUserMedia({
              maxARVideoSize: 320, // do AR processing on scaled down video of this size
              facing: "environment",
              onSuccess: function(video) {
                console.log('got video', video);
              }
            });
            */

            // get the canvas DOM element
            var canvas = document.getElementById('renderCanvas');
            canvas.height = v.height;
            canvas.width = v.width;

            // load the 3D engine
            var engine = new BABYLON.Engine(canvas, true);
            engine.setSize(v.width, v.height);

            var markerRoot;
            var camera;

            // createScene function that creates and return the scene
            var createScene = function () {
                // create a basic BJS Scene object
                var scene = new BABYLON.Scene(engine);
                scene.useRightHandedSystem = true;

                camera = new BABYLON.Camera('camera1', new BABYLON.Vector3(0, 0, 0), scene);

                camera.attachControl(canvas, true);
                window.camera = camera;

                markerRoot = new BABYLON.AbstractMesh('markerRoot', scene);

                markerRoot.wasVisible = false;
                markerRoot.markerMatrix = new Float64Array(12);

                // create a basic light, aiming 0,1,0 - meaning, to the sky
                var light = new BABYLON.HemisphericLight('light1', new BABYLON.Vector3(0, 1, 0), scene);

                // create a box
                var box = BABYLON.Mesh.CreateBox('box1', 1, scene);
                //set the marker object as box parent
                box.parent = markerRoot;

                // return the created scene
                return scene;
            };

            // call the createScene function
            var scene = createScene();

            var arController = null;

            // run the render loop
            engine.runRenderLoop(function () {
                if (!arController) {
                    return;
                }

                arController.detectMarker(v);
                var markerNum = arController.getMarkerNum();

                if (markerNum > 0) {

                    if (markerRoot.isVisible) {
                        arController.getTransMatSquareCont(0, 1, markerRoot.markerMatrix, markerRoot.markerMatrix);
                    } else {
                        arController.getTransMatSquare(0 /* Marker index */, 1 /* Marker width */, markerRoot.markerMatrix);
                    }

                    markerRoot.isVisible = true;
                    markerRoot.getChildMeshes().forEach(function (mesh) {
                        mesh.isVisible = true
                    });

                    arController.arglCameraViewRHf(arController.transMatToGLMat(markerRoot.markerMatrix), markerRoot._worldMatrix.m);
                } else {
                    markerRoot.isVisible = false;
                    markerRoot.getChildMeshes().forEach(function (mesh) {
                        mesh.isVisible = false;
                    });
                }

                arController.debugDraw();

                
            });


            var cameraParam = new ARCameraParam();
            cameraParam.onload = async function () {

                arController = new ARController(320, 240, cameraParam);
                arController.debugSetup();

                camera.freezeProjectionMatrix(BABYLON.Matrix.FromArray(arController.getCameraMatrix()));
            };
            cameraParam.load('assets/camera_para.dat');


            // the canvas/window resize event handler
            window.addEventListener('resize', function () {
                engine.resize();
            });
            scene.render();
        </script>
        -->
    </body>
</html>